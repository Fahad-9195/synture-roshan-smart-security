<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ  Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --bg: #020617;
      --card-bg: #020617;
      --card-gradient: radial-gradient(circle at top left, #0f172a, #020617);
      --card-border: #1e293b;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --accent: #38bdf8;
      --danger: #ef4444;
      --warning: #eab308;
      --info: #22c55e;
      --success: #10b981;
      --purple: #a855f7;
      --orange: #fb923c;
    }

    body {
      margin: 0;
      padding: 20px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #020617 50%, #000000 100%);
      background-attachment: fixed;
      color: var(--text-main);
      display: flex;
      justify-content: center;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 20% 50%, rgba(16, 185, 129, 0.08) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(56, 189, 248, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    .dashboard {
      width: 100%;
      max-width: 1250px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow:
        0 40px 80px rgba(0, 0, 0, 0.6),
        0 0 100px rgba(16, 185, 129, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
      padding: 24px 28px 32px;
      backdrop-filter: blur(20px);
      position: relative;
      z-index: 1;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--card-border);
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.75rem;
      font-weight: 800;
      background: linear-gradient(135deg, #10b981 0%, #38bdf8 50%, #a855f7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-size: 200% auto;
      animation: shimmer 3s linear infinite;
      letter-spacing: -0.5px;
    }
    
    @keyframes shimmer {
      0% { background-position: 0% center; }
      100% { background-position: 200% center; }
    }

    .title-group p {
      margin: 3px 0 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 0.8rem;
      padding: 8px 16px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s ease;
      font-weight: 500;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.5s, height 0.5s;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      border-color: rgba(148, 163, 184, 0.8);
    }

    .btn.primary {
      background: linear-gradient(135deg, #10b981, #059669);
      border-color: transparent;
      color: white;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
    }
    
    .btn.primary:hover {
      background: linear-gradient(135deg, #059669, #047857);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
    }

    .btn.danger {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    .btn.paused {
      opacity: 0.6;
    }

    .conn-status {
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
    }

    .conn-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }

    .conn-status.conn-offline .conn-dot {
      background: #ef4444;
    }

    .offline-banner {
      display: none;
      margin-top: 6px;
      padding: 6px 10px;
      font-size: 0.75rem;
      background: rgba(248, 113, 113, 0.1);
      border-radius: 999px;
      border: 1px solid rgba(248, 113, 113, 0.5);
      color: #fecaca;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }

    .card {
      background: var(--card-gradient);
      border-radius: 16px;
      border: 1px solid var(--card-border);
      padding: 16px 18px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4),
                  inset 0 1px 0 rgba(255, 255, 255, 0.05);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.03), transparent);
      transition: left 0.5s;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 48px rgba(0, 0, 0, 0.6),
                  inset 0 1px 0 rgba(255, 255, 255, 0.1);
      border-color: rgba(148, 163, 184, 0.5);
    }
    
    .card:hover::before {
      left: 100%;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 6px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 0.95rem;
    }

    .card-header .muted {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin: 0;
    }

    .small-label {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .big-number {
      font-size: 2.25rem;
      margin: 8px 0 0;
      font-weight: 800;
      letter-spacing: -1px;
      background: linear-gradient(135deg, var(--accent), var(--info));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .danger-card {
      border-color: rgba(248, 113, 113, 0.7);
    }

    .danger-card.danger-glow {
      box-shadow:
        0 0 0 1px rgba(248, 113, 113, 0.6),
        0 0 40px rgba(248, 113, 113, 0.5);
    }

    .risk-bar-wrap {
      margin-top: 4px;
    }

    .risk-bar {
      height: 9px;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: #020617;
    }

    #risk-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(to left, #22c55e, #eab308, #ef4444);
      transition: width 0.3s ease-out;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .layout-main {
      display: grid;
      grid-template-columns: minmax(0, 0.9fr) minmax(0, 1.1fr);
      gap: 10px;
      margin-bottom: 12px;
    }

    #liveChart {
      width: 100%;
      height: 220px;
    }

    #unified-map {
      width: 100%;
      height: 260px;
      border-radius: 12px;
      overflow: hidden;
    }

    .officer-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }

    .officer-pill {
      padding: 5px 9px;
      border-radius: 999px;
      font-size: 0.78rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: #020617;
    }

    .officer-pill span {
      font-weight: 600;
    }

    .officer-pill.safe {
      border-color: #22c55e;
      color: #bbf7d0;
    }

    .officer-pill.unstable {
      border-color: #eab308;
      color: #fef3c7;
    }

    .officer-pill.emergency {
      border-color: #ef4444;
      color: #fee2e2;
    }

    .filters-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 0.78rem;
    }

    .filter-group select {
      background: #020617;
      color: var(--text-main);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      padding: 4px 8px;
      font-size: 0.8rem;
      outline: none;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.82rem;
      border-radius: 12px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(to left, #020617, #0f172a);
    }

    th,
    td {
      padding: 7px 8px;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
      white-space: nowrap;
    }

    th {
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.96);
    }

    tbody tr:hover {
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .level-info {
      background: rgba(34, 197, 94, 0.08);
    }

    .level-warning {
      background: rgba(234, 179, 8, 0.12);
    }

    .level-danger {
      background: rgba(248, 113, 113, 0.16);
    }

    .row-resolved {
      opacity: 0.6;
    }

    .resolve-btn-table {
      padding: 4px 10px;
      background: rgba(34, 197, 94, 0.2);
      border: 1px solid #22c55e;
      border-radius: 6px;
      color: #22c55e;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .resolve-btn-table:hover {
      background: #22c55e;
      color: white;
      transform: scale(1.05);
    }

    .resolve-btn-table:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(100, 116, 139, 0.2);
      border-color: #64748b;
      color: #64748b;
    }

    .number-pulse {
      animation: numPulse 0.4s ease-out;
    }

    @keyframes numPulse {
      0% { transform: scale(1); }
      40% { transform: scale(1.12); }
      100% { transform: scale(1); }
    }

    #toast-container {
      position: fixed;
      top: 16px;
      right: 16px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 9999;
    }

    .toast {
      min-width: 220px;
      max-width: 320px;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.7);
      background: #e5e7eb;
      animation: toastIn 0.25s ease-out;
    }

    .toast-danger {
      background: #fee2e2;
      border: 1px solid #ef4444;
    }

    .toast-warning {
      background: #fef3c7;
      border: 1px solid #eab308;
    }

    .toast-info {
      background: #dbeafe;
      border: 1px solid #3b82f6;
    }

    .toast-close {
      cursor: pointer;
      opacity: 0.7;
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .devices-summary {
      list-style: none;
      padding: 0;
      margin: 6px 0 0;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .devices-summary li {
      margin-bottom: 3px;
    }

    /* light theme */
    body.light-theme {
      background: #f1f5f9;
      color: #0f172a;
    }

    body.light-theme .dashboard {
      background: #ffffff;
      border-color: #cbd5f5;
      box-shadow:
        0 14px 40px rgba(15, 23, 42, 0.12),
        0 0 0 1px rgba(148, 163, 184, 0.2);
    }

    body.light-theme .card {
      background: #f8fafc;
      border-color: #e2e8f0;
    }

    body.light-theme .muted {
      color: #64748b;
    }

    body.light-theme .btn {
      background: #f9fafb;
    }

    body.light-theme table tbody tr:nth-child(even) {
      background: #f8fafc;
    }

    body.light-theme .level-info {
      background: #dcfce7;
    }

    body.light-theme .level-warning {
      background: #fef9c3;
    }

    body.light-theme .level-danger {
      background: #fee2e2;
    }

    @media (max-width: 900px) {
      body {
        padding: 10px;
      }
      .layout-main {
        grid-template-columns: 1fr;
      }
      .stats {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .stats {
        grid-template-columns: 1fr;
      }
      th,
      td {
        font-size: 0.75rem;
      }
    }
    
    /* Additional Beautiful Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
      50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.8), 0 0 30px rgba(16, 185, 129, 0.6); }
    }
    
    .dashboard-header {
      animation: float 6s ease-in-out infinite;
    }
    
    .card:hover .small-label i {
      transform: scale(1.2) rotate(10deg);
      transition: transform 0.3s ease;
    }
    
    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #10b981, #059669);
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #059669, #047857);
    }
    
    /* Table Enhancement */
    tbody tr {
      transition: all 0.3s ease;
    }
    
    tbody tr:hover {
      transform: scale(1.01);
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <header class="dashboard-header">
      <div class="title-group">
        <h1><i class="fas fa-home-lg-alt"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p><i class="fas fa-shield-halved"></i> Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ¥Ø¯Ø§Ø±Ø© Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© | Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù†Ø²Ù„Ùƒ 24/7</p>
      </div>
      <div style="display: flex; flex-direction: column; gap: 8px; align-items: flex-end;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <span style="font-size: 12px; color: #94a3b8;"><i class="fas fa-user-circle"></i> <span id="usernameDisplay"></span></span>
          <button id="logout-btn" class="btn" style="padding: 6px 12px; font-size: 12px; background: rgba(239, 68, 68, 0.2); border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;">
            <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
          </button>
        </div>
        <div id="connection-status" class="conn-status">
          <span class="conn-dot"></span> <i class="fas fa-wifi"></i> Ù…ØªØµÙ„
        </div>
        <div id="offline-banner" class="offline-banner">
          <i class="fas fa-exclamation-triangle"></i> Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ù€ API Ø§Ù„Ø¢Ù†ØŒ ÙŠØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù…Ø¤Ù‚ØªÙ‹Ø§.
        </div>
      </div>
    </header>

    <div class="controls-row">
      <button id="simulation-toggle-btn" class="btn"><i class="fas fa-play"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©</button>
      <button id="manual-burglary-btn" class="btn danger"><i class="fas fa-bell"></i> Ø¨Ù„Ø§Øº Ø³Ø±Ù‚Ø© (Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø²Ù„)</button>
      <button id="police-report-btn" class="btn danger"><i class="fas fa-exclamation-triangle"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ù„Ù„Ø´Ø±Ø·Ø©</button>
      <button id="resolve-all-btn" class="btn danger"><i class="fas fa-check-double"></i> Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</button>
      <button id="theme-toggle-btn" class="btn"><i class="fas fa-sun"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­</button>
    </div>

    <section class="stats">
      <div class="card">
        <div class="small-label"><i class="fas fa-clock"></i> Ø¢Ø®Ø± Ø­Ø¯Ø«</div>
        <p id="last-event" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</p>
      </div>
      <div class="card">
        <div class="small-label"><i class="fas fa-exclamation-triangle"></i> Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ø¹Ø§Ù…</div>
        <div class="risk-bar-wrap">
          <div class="risk-bar">
            <div id="risk-bar-fill"></div>
          </div>
        </div>
        <p id="risk-label" class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</p>
      </div>
      <div class="card danger-card">
        <div class="small-label"><i class="fas fa-fire"></i> Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
        <p id="danger-count" class="big-number">0</p>
      </div>
      <div class="card">
        <div class="small-label"><i class="fas fa-list"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</div>
        <p id="total-events" class="big-number">0</p>
      </div>
    </section>

    <!-- Resolution Stats Section -->
    <section class="stats" style="margin-top: 20px;">
      <div class="card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.05)); border-color: rgba(16, 185, 129, 0.4);">
        <div class="small-label"><i class="fas fa-check-circle"></i> Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ù„ÙˆÙ„</div>
        <p id="total-resolutions" class="big-number" style="color: #10b981;">0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.2), rgba(251, 146, 60, 0.05)); border-color: rgba(251, 146, 60, 0.4);">
        <div class="small-label"><i class="fas fa-calendar-day"></i> Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…</div>
        <p id="today-resolutions" class="big-number" style="color: #fb923c;">0</p>
      </div>
      <div class="card" style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(168, 85, 247, 0.05)); border-color: rgba(168, 85, 247, 0.4);">
        <div class="small-label"><i class="fas fa-skull-crossbones"></i> Ø­Ù„ÙˆÙ„ Ø®Ø·Ø±Ø©</div>
        <p id="danger-resolutions" class="big-number" style="color: #a855f7;">0</p>
      </div>
    </section>

    <!-- Recent Resolutions Section -->
    <section class="card" style="margin-top: 20px;">
      <div class="card-header">
        <h2><i class="fas fa-clipboard-check"></i> Ø¢Ø®Ø± Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù†ÙØ°Ø©</h2>
        <p class="muted">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙŠ ØªÙ… Ø­Ù„Ù‡Ø§ Ù…Ø¤Ø®Ø±Ø§Ù‹</p>
      </div>
      <div id="resolutions-list" style="max-height: 300px; overflow-y: auto;"></div>
    </section>

    <section class="layout-main">
      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-chart-line"></i> Ù…Ø®Ø·Ø· Ø­ÙŠ Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
          <p class="muted">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«</p>
        </div>
        <canvas id="liveChart"></canvas>
      </div>

      <div class="card">
        <div class="card-header">
          <h2><i class="fas fa-map-marked-alt"></i> Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…Ù†Ø²Ù„ÙŠ</h2>
          <p class="muted">
            <i class="fas fa-map-pin"></i> Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ù†Ø²Ù„
          </p>
        </div>
        <div id="unified-map"></div>
      </div>
    </section>

    <section class="card" style="margin-top:10px;">
      <div class="card-header">
        <h2><i class="fas fa-mobile-alt"></i> Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h2>
        <p class="muted">Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¥Ø±Ø³Ø§Ù„Ø§Ù‹ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª</p>
      </div>
      <ul id="devices-summary" class="devices-summary"></ul>
    </section>

    <section class="card" style="margin-top:10px;">
      <div class="card-header">
        <h2><i class="fas fa-bell"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø­Ø¯Ø§Ø«</h2>
        <p class="muted">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚ØªØŒ Ø§Ù„Ø®Ø·ÙˆØ±Ø©ØŒ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ Ø§Ù„Ø­Ø§Ù„Ø©</p>
      </div>

      <div class="filters-row">
        <div class="filter-group">
          <span>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·ÙˆØ±Ø©</span>
          <select id="level-filter">
            <option value="all">Ø§Ù„ÙƒÙ„</option>
            <option value="info">info</option>
            <option value="warning">warning</option>
            <option value="danger">danger</option>
          </select>
        </div>

        <div class="filter-group">
          <span>Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©</span>
          <select id="time-filter">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª</option>
            <option value="5">Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚</option>
            <option value="15">Ø¢Ø®Ø± 15 Ø¯Ù‚ÙŠÙ‚Ø©</option>
            <option value="60">Ø¢Ø®Ø± Ø³Ø§Ø¹Ø©</option>
          </select>
        </div>

        <div class="filter-group">
          <span>Ø§Ù„Ø¬Ù‡Ø§Ø²</span>
          <select id="device-filter">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>
          </select>
        </div>

        <div class="filter-group">
          <span>Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº</span>
          <select id="status-filter">
            <option value="open">Ù…ÙØªÙˆØ­ ÙÙ‚Ø·</option>
            <option value="resolved">ØªÙ… Ø§Ù„Ø­Ù„ ÙÙ‚Ø·</option>
            <option value="all">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>Ø§Ù„Ù†ÙˆØ¹</th>
            <th>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="events-table-body"></tbody>
      </table>
    </section>

    <input type="file" id="file-input" accept=".csv,text/csv" style="display:none;" />

    <audio id="alert-sound">
      <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg" />
    </audio>
  </div>

  <div id="toast-container"></div>

  <script>
    /*************** Authentication Check ***************/
    // Check if user is logged in
    const homeAuth = localStorage.getItem('homeAuth');
    if (homeAuth !== 'true') {
      window.location.href = '/static/home-login.html';
    }

    // Get logged in username
    const currentUser = localStorage.getItem('homeUsername') || 'Ù…Ø³ØªØ®Ø¯Ù…';

    /*************** Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ***************/
    const API_URL = "https://syntrue-absher.onrender.com/api/events";
    const DEFAULT_HOME_ID = "HOME-1234";
    const DEFAULT_ABSHER_ID = "1234567890";

    const DEVICE_LOCATIONS = {
      door_sensor_1: [24.7136, 46.6753],
      motion_sensor_1: [24.7143, 46.6768],
      camera_front: [24.7129, 46.6742],
      gas_sensor_kitchen: [24.7130, 46.6760],
    };

    // Ù…ÙˆØ§Ù‚Ø¹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø¹Ø³ÙƒØ±ÙŠÙŠÙ†
    const OFFICER_LOCATIONS = {
      officer_1: [24.7150, 46.6770],
      officer_2: [24.7118, 46.6765],
      officer_3: [24.7122, 46.6780],
    };

    const LEVEL_COLORS = {
      info: "#22c55e",
      warning: "#eab308",
      danger: "#ef4444",
    };

    let allEvents = [];
    let visibleEventsCache = [];
    let lastTotal = 0;
    let lastDanger = 0;
    let fetchingEnabled = true;
    let simulationEnabled = false;
    let simulationInterval = null;

    let currentLevelFilter = "all";
    let currentTimeFilter = "all";
    let currentDeviceFilter = "all";
    let currentStatusFilter = "open";

    /*************** DOM ***************/
    const totalEl = document.getElementById("total-events");
    const dangerEl = document.getElementById("danger-count");
    const lastEventEl = document.getElementById("last-event");
    const riskBarFill = document.getElementById("risk-bar-fill");
    const riskLabel = document.getElementById("risk-label");

    const levelSelect = document.getElementById("level-filter");
    const timeSelect = document.getElementById("time-filter");
    const deviceSelect = document.getElementById("device-filter");
    const statusSelect = document.getElementById("status-filter");

    const connectionStatus = document.getElementById("connection-status");
    const offlineBanner = document.getElementById("offline-banner");
    const simulationToggleBtn = document.getElementById("simulation-toggle-btn");
    const manualBurglaryBtn = document.getElementById("manual-burglary-btn");
    const policeReportBtn = document.getElementById("police-report-btn");
    const resolveAllBtn = document.getElementById("resolve-all-btn");
    const themeToggleBtn = document.getElementById("theme-toggle-btn");

    const devicesSummaryEl = document.getElementById("devices-summary");

    const officerSummaryText = document.getElementById("officer-summary-text");
    const officerSafeEl = document.getElementById("officer-safe-count");
    const officerUnstableEl = document.getElementById("officer-unstable-count");
    const officerEmergencyEl = document.getElementById("officer-emergency-count");

    const toastContainer = document.getElementById("toast-container");
    const alertSound = document.getElementById("alert-sound");

    /*************** Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ­Ø¯Ø© ***************/
    let mainMap = null;
    let homeDevicesLayer, heatLayer, officerLayer, officerRouteLayer, droneLayer, droneRouteLayer;
    let deviceMarkers = {};
    let officerMarkers = {};
    let heatPoints = [];
    let patrolCarMarker = null;
    let droneMarker = null;
    let patrolStep = 0;

    function initUnifiedMap() {
      const center = [24.7136, 46.6753];
      mainMap = L.map("unified-map").setView(center, 14);

      L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 20,
      }).addTo(mainMap);

      homeDevicesLayer = L.layerGroup().addTo(mainMap);
      heatLayer = L.heatLayer([], { radius: 35, blur: 25, maxZoom: 20 }).addTo(mainMap);
      officerLayer = L.layerGroup().addTo(mainMap);
      officerRouteLayer = L.layerGroup().addTo(mainMap);
      droneLayer = L.layerGroup().addTo(mainMap);
      droneRouteLayer = L.layerGroup().addTo(mainMap);

      const overlays = {
        "ğŸ  Ø§Ù„Ù…Ù†Ø²Ù„ â€º Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©": homeDevicesLayer,
        "ğŸ  Ø§Ù„Ù…Ù†Ø²Ù„ â€º Heatmap": heatLayer,
        "ğŸš“ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª â€º Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹": officerLayer,
        "ğŸš“ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª â€º Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª": officerRouteLayer,
        "ğŸ›¸ Ø§Ù„Ø¯Ø±ÙˆÙ† â€º Ø§Ù„Ù…Ø³Ø§Ø±": droneRouteLayer,
        "ğŸ›¸ Ø§Ù„Ø¯Ø±ÙˆÙ† â€º Ø§Ù„Ù…ÙˆÙ‚Ø¹": droneLayer,
      };

      L.control.layers(null, overlays, { collapsed: false }).addTo(mainMap);

      // Ù…Ø³ØªØ·ÙŠÙ„ ÙŠÙ…Ø«Ù„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø²Ù„
      const homeBounds = [
        [24.7126, 46.6745],
        [24.7146, 46.6765],
      ];
      L.rectangle(homeBounds, {
        color: "#38bdf8",
        weight: 1,
        dashArray: "4 4",
        fillOpacity: 0.03,
      }).addTo(mainMap);

      // Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ù†Ø²Ù„
      Object.entries(DEVICE_LOCATIONS).forEach(([id, coords]) => {
        const m = L.circleMarker(coords, {
          radius: 6,
          color: "#0ea5e9",
          fillColor: "#0ea5e9",
          fillOpacity: 0.9,
        }).addTo(homeDevicesLayer);
        m.bindPopup(`<b>${id}</b>`);
        deviceMarkers[id] = m;
      });

      // Ù…Ø³Ø§Ø± Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª
      const route = [
        [24.7125, 46.6735],
        [24.7135, 46.6748],
        [24.7143, 46.6760],
        [24.7150, 46.6770],
        [24.7140, 46.6780],
      ];
      L.polyline(route, {
        color: "#38bdf8",
        weight: 3,
        dashArray: "6 6",
      }).addTo(officerRouteLayer);

      patrolCarMarker = L.circleMarker(route[0], {
        radius: 7,
        color: "#0ea5e9",
        fillColor: "#0ea5e9",
        fillOpacity: 0.9,
      }).addTo(officerLayer).bindPopup("ğŸš“ Ø¯ÙˆØ±ÙŠØ© Ø£Ù…Ù†ÙŠØ©");

      // Ù…Ø³Ø§Ø± Ø§Ù„Ø¯Ø±ÙˆÙ†
      const droneRoute = [
        [24.7160, 46.6760],
        [24.7152, 46.6750],
        [24.7144, 46.6740],
        [24.7136, 46.6750],
      ];
      L.polyline(droneRoute, {
        color: "#facc15",
        weight: 2,
        dashArray: "2 6",
      }).addTo(droneRouteLayer);

      droneMarker = L.circleMarker(droneRoute[0], {
        radius: 6,
        color: "#facc15",
        fillColor: "#facc15",
        fillOpacity: 0.9,
      }).addTo(droneLayer).bindPopup("ğŸ›¸ Ø¯Ø±ÙˆÙ† Ù…Ø±Ø§Ù‚Ø¨Ø©");

      let dStep = 0;

      setInterval(() => {
        patrolStep = (patrolStep + 1) % route.length;
        patrolCarMarker.setLatLng(route[patrolStep]);

        dStep = (dStep + 1) % droneRoute.length;
        droneMarker.setLatLng(droneRoute[dStep]);
      }, 2500);
    }

    function updateMapForEvent(ev) {
      if (!mainMap) return;

      // Ù„Ùˆ Ø¬Ù‡Ø§Ø² Ù…Ù†Ø²Ù„
      if (DEVICE_LOCATIONS[ev.device_id]) {
        const coords = DEVICE_LOCATIONS[ev.device_id];
        const marker = deviceMarkers[ev.device_id];

        if (marker) {
          const color = LEVEL_COLORS[ev.level] || "#0ea5e9";
          marker.setStyle({ color, fillColor: color, radius: 10 });
          setTimeout(() => {
            marker.setStyle({ color: "#0ea5e9", fillColor: "#0ea5e9", radius: 6 });
          }, 800);
        }

        const weight =
          ev.level === "danger" ? 1.0 : ev.level === "warning" ? 0.6 : 0.3;
        heatPoints.push([coords[0], coords[1], weight]);
        if (heatPoints.length > 250) heatPoints = heatPoints.slice(-250);
        heatLayer.setLatLngs(heatPoints);
      }

      // Ù„Ùˆ Ø¹Ø³ÙƒØ±ÙŠ
      if (ev.device_id && ev.device_id.startsWith("officer_")) {
        let coords = OFFICER_LOCATIONS[ev.device_id];
        if (!coords) coords = [24.7136, 46.6753];

        let color = "#22c55e";
        if (ev.level === "warning") color = "#eab308";
        if (ev.level === "danger") color = "#ef4444";

        let m = officerMarkers[ev.device_id];
        if (!m) {
          m = L.circleMarker(coords, {
            radius: 9,
            color,
            fillColor: "#0f172a",
            fillOpacity: 0.9,
          })
            .addTo(officerLayer)
            .bindPopup(`ğŸ‘® ${ev.device_id}`);
          officerMarkers[ev.device_id] = m;
        } else {
          m.setLatLng(coords);
          m.setStyle({ color });
        }
      }
    }

    /*************** Ù…Ø®Ø·Ø· Ø­ÙŠ ***************/
    let liveChart = null;

    function initLiveChart() {
      const ctx = document.getElementById("liveChart").getContext("2d");
      liveChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [
            {
              label: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«",
              data: [],
              borderColor: "#38bdf8",
              backgroundColor: "rgba(56,189,248,0.15)",
              tension: 0.3,
              fill: true,
              pointRadius: 2,
              pointHoverRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: "#e5e7eb" } },
          },
          scales: {
            x: { ticks: { color: "#9ca3af" } },
            y: { ticks: { color: "#9ca3af" }, beginAtZero: true },
          },
        },
      });
    }

    function updateLiveChart(totalCount) {
      if (!liveChart) return;
      const now = new Date();
      const label = now.toTimeString().slice(0, 8);
      liveChart.data.labels.push(label);
      liveChart.data.datasets[0].data.push(totalCount);
      if (liveChart.data.labels.length > 20) {
        liveChart.data.labels.shift();
        liveChart.data.datasets[0].data.shift();
      }
      liveChart.update("none");
    }

    /*************** Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© ***************/
    function parseEventTime(e) {
      return new Date(e.timestamp);
    }

    // Fetch and display resolutions
    async function fetchResolutions() {
      try {
        // Get resolutions
        const resResponse = await fetch('https://syntrue-absher.onrender.com/api/resolutions?limit=10');
        const resolutions = await resResponse.json();
        
        // Get stats
        const statsResponse = await fetch('https://syntrue-absher.onrender.com/api/resolutions/stats');
        const stats = await statsResponse.json();
        
        // Update stats cards
        document.getElementById('total-resolutions').textContent = stats.total || 0;
        document.getElementById('today-resolutions').textContent = stats.today || 0;
        document.getElementById('danger-resolutions').textContent = stats.by_level?.danger || 0;
        
        
        // Display resolutions list - ONLY HOME resolutions
        const resList = document.getElementById('resolutions-list');
        const homeResolutions = resolutions.filter(r => r.resolution_type === 'home');
        
        if (homeResolutions.length === 0) {
          resList.innerHTML = `
            <div style="text-align: center; padding: 40px 20px;">
              <i class="fas fa-clipboard-list" style="font-size: 48px; color: #475569; margin-bottom: 16px;"></i>
              <p style="color: #64748b; font-size: 14px; margin: 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„ÙˆÙ„ Ù…Ù†ÙØ°Ø© Ø¨Ø¹Ø¯</p>
              <p style="color: #475569; font-size: 12px; margin-top: 8px;">Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªÙŠ ØªÙ… Ø­Ù„Ù‡Ø§ Ù‡Ù†Ø§</p>
            </div>
          `;
          return;
        }
        
        resList.innerHTML = homeResolutions.map(res => {
          const time = new Date(res.resolved_at);
          const timeStr = time.toLocaleString('ar-SA');
          const mins = Math.floor(res.response_time_seconds / 60);
          const secs = res.response_time_seconds % 60;
          const responseTimeStr = mins > 0 ? `${mins}Ø¯ ${secs}Ø«` : `${secs}Ø«`;
          
          const levelColors = {
            danger: '#ef4444',
            warning: '#f59e0b',
            info: '#10b981'
          };
          const levelIcons = {
            danger: '<i class="fas fa-exclamation-circle"></i>',
            warning: '<i class="fas fa-exclamation-triangle"></i>',
            info: '<i class="fas fa-info-circle"></i>'
          };
          
          return `
            <div style="padding: 14px 16px; margin: 10px 0; background: linear-gradient(135deg, rgba(15, 23, 42, 0.8), rgba(30, 41, 59, 0.4)); border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.3); border-right: 4px solid ${levelColors[res.original_level] || '#64748b'}; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);" onmouseover="this.style.transform='translateX(-4px)'; this.style.boxShadow='0 6px 20px rgba(16, 185, 129, 0.3)'" onmouseout="this.style.transform='translateX(0)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.3)'">
              <div style="display: flex; justify-content: space-between; align-items: start; gap: 12px;">
                <div style="flex: 1;">
                  <div style="font-size: 15px; font-weight: 700; margin-bottom: 6px; color: #e5e7eb; display: flex; align-items: center; gap: 8px;">
                    <span style="color: ${levelColors[res.original_level] || '#64748b'};">${levelIcons[res.original_level] || '<i class="fas fa-clipboard"></i>'}</span>
                    ${res.device_name}
                  </div>
                  <div style="font-size: 12px; color: #cbd5e1; margin-bottom: 8px; line-height: 1.5;">
                    <i class="fas fa-tag"></i> ${res.notes || res.original_type}
                  </div>
                  <div style="font-size: 11px; color: #94a3b8; display: flex; flex-wrap: wrap; gap: 12px;">
                    <span><i class="fas fa-clock"></i> ${timeStr}</span>
                    <span style="color: #38bdf8;"><i class="fas fa-bolt"></i> ${responseTimeStr}</span>
                    <span><i class="fas fa-user"></i> ${res.resolved_by}</span>
                  </div>
                </div>
                <div style="padding: 6px 14px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.3), rgba(16, 185, 129, 0.15)); border-radius: 20px; font-size: 11px; color: #10b981; white-space: nowrap; font-weight: 600; border: 1px solid rgba(16, 185, 129, 0.4); display: flex; align-items: center; gap: 4px;">
                  <i class="fas fa-check-circle"></i> ØªÙ… Ø§Ù„Ø­Ù„
                </div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (error) {
        console.error('Error fetching resolutions:', error);
      }
    }

    function filterByTime(events) {
      if (currentTimeFilter === "all") return events;
      const mins = parseInt(currentTimeFilter, 10);
      const now = Date.now();
      const threshold = now - mins * 60 * 1000;
      return events.filter((e) => parseEventTime(e).getTime() >= threshold);
    }

    function filterByLevel(events) {
      if (currentLevelFilter === "all") return events;
      return events.filter((e) => e.level === currentLevelFilter);
    }

    function filterByDevice(events) {
      if (currentDeviceFilter === "all") return events;
      return events.filter((e) => e.device_id === currentDeviceFilter);
    }

    function filterByStatus(events) {
      if (currentStatusFilter === "all") return events;
      return events.filter((e) => (e.status || "open") === currentStatusFilter);
    }

    function animateNumber(el, from, to) {
      if (from === to) {
        el.textContent = to;
        return;
      }
      const duration = 300;
      const start = performance.now();
      function step(now) {
        const progress = Math.min((now - start) / duration, 1);
        const v = Math.round(from + (to - from) * progress);
        el.textContent = v;
        if (progress < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
      el.classList.remove("number-pulse");
      void el.offsetWidth;
      el.classList.add("number-pulse");
    }

    function showToast(message, level = "info") {
      const toast = document.createElement("div");
      toast.classList.add("toast");
      if (level === "danger") toast.classList.add("toast-danger");
      else if (level === "warning") toast.classList.add("toast-warning");
      else toast.classList.add("toast-info");

      const msg = document.createElement("p");
      msg.textContent = message;
      msg.style.margin = "0 6px 0 0";

      const close = document.createElement("span");
      close.textContent = "Ã—";
      close.classList.add("toast-close");
      close.onclick = () => toast.remove();

      toast.appendChild(msg);
      toast.appendChild(close);
      toastContainer.appendChild(toast);
      if (toastContainer.children.length > 10) {
        toastContainer.removeChild(toastContainer.firstChild);
      }
      setTimeout(() => toast.remove(), 6000);
    }

    function updateRiskIndicator(activeEvents) {
      if (activeEvents.length === 0) {
        riskBarFill.style.width = "0%";
        riskLabel.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨Ù„Ø§ØºØ§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹";
        document.querySelector(".danger-card")?.classList.remove("danger-glow");
        return;
      }
      const dangerCount = activeEvents.filter((e) => e.level === "danger").length;
      const ratio = (dangerCount / activeEvents.length) * 100;
      riskBarFill.style.width = `${Math.min(100, ratio)}%`;

      let txt = "";
      if (ratio < 10) txt = "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø± Ù…Ù†Ø®ÙØ¶";
      else if (ratio < 30) txt = "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø± Ù…ØªÙˆØ³Ø·";
      else txt = "Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø± Ù…Ø±ØªÙØ¹";
      riskLabel.textContent = txt;

      const dangerCard = document.querySelector(".danger-card");
      if (ratio >= 30 && dangerCard) dangerCard.classList.add("danger-glow");
      else if (dangerCard) dangerCard.classList.remove("danger-glow");
    }

    function updateDevicesSummary(events) {
      const counts = {};
      events.forEach((e) => {
        counts[e.device_id] = (counts[e.device_id] || 0) + 1;
      });

      const devices = Object.keys(counts);
      const prev = deviceSelect.value;

      deviceSelect.innerHTML = `<option value="all">ÙƒÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</option>`;
      devices.forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = `${d} (${counts[d]} Ø­Ø¯Ø«)`;
        deviceSelect.appendChild(opt);
      });
      if (devices.includes(prev)) deviceSelect.value = prev;

      devicesSummaryEl.innerHTML = "";
      if (devices.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø¬Ù‡Ø²Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        devicesSummaryEl.appendChild(li);
        return;
      }

      const sorted = devices
        .map((d) => ({ id: d, count: counts[d] }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

      sorted.forEach((d) => {
        const li = document.createElement("li");
        li.textContent = `${d.id} - ${d.count} Ø­Ø¯Ø«`;
        devicesSummaryEl.appendChild(li);
      });
    }

    function updateTopCards(activeEvents, visibleEvents, allViewEvents) {
      animateNumber(totalEl, lastTotal, allViewEvents.length);
      lastTotal = allViewEvents.length;

      const dangerCount = visibleEvents.filter(
        (e) => e.level === "danger" && (e.status || "open") === "open"
      ).length;
      animateNumber(dangerEl, lastDanger, dangerCount);
      lastDanger = dangerCount;

      if (allViewEvents.length > 0) {
        const last = allViewEvents[allViewEvents.length - 1];
        lastEventEl.textContent = `${last.timestamp} - ${last.device_id} - ${last.type}`;
      } else {
        lastEventEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª";
      }

      updateLiveChart(allViewEvents.length);
    }

    function updateTable(events) {
      const tbody = document.getElementById("events-table-body");
      tbody.innerHTML = "";
      events
        .slice()
        .reverse()
        .forEach((event) => {
          const tr = document.createElement("tr");

          if (event.level === "info") tr.classList.add("level-info");
          else if (event.level === "warning") tr.classList.add("level-warning");
          else if (event.level === "danger") tr.classList.add("level-danger");

          if (event.status === "resolved") tr.classList.add("row-resolved");

          const tdTime = document.createElement("td");
          tdTime.textContent = event.timestamp;
          const tdDev = document.createElement("td");
          tdDev.textContent = event.device_id;
          const tdType = document.createElement("td");
          tdType.textContent = event.type;
          const tdLevel = document.createElement("td");
          tdLevel.textContent = event.level;
          const tdStatus = document.createElement("td");
          tdStatus.textContent = event.status || "open";
          
          const tdAction = document.createElement("td");
          if (event.status !== "resolved" && (event.level === "warning" || event.level === "danger")) {
            const resolveBtn = document.createElement("button");
            resolveBtn.className = "resolve-btn-table";
            resolveBtn.textContent = "âœ… Ø­Ù„";
            resolveBtn.onclick = () => resolveHomeEvent(event);
            tdAction.appendChild(resolveBtn);
          } else if (event.status === "resolved") {
            tdAction.textContent = "ØªÙ… Ø§Ù„Ø­Ù„ âœ“";
            tdAction.style.color = "#22c55e";
            tdAction.style.fontSize = "11px";
          } else {
            tdAction.textContent = "-";
            tdAction.style.color = "#64748b";
          }

          tr.appendChild(tdTime);
          tr.appendChild(tdDev);
          tr.appendChild(tdType);
          tr.appendChild(tdLevel);
          tr.appendChild(tdStatus);
          tr.appendChild(tdAction);
          tbody.appendChild(tr);
        });
    }

    function handleNewEvents(prevCount, newEvents) {
      if (newEvents.length <= prevCount) return;
      const just = newEvents.slice(prevCount);
      just.forEach((ev) => {
        if (ev.status === "resolved") return;

        if (ev.level === "danger") {
          showToast(`ğŸš¨ Ø®Ø·Ø± Ù…Ù† ${ev.device_id}: ${ev.type}`, "danger");
          if (alertSound) {
            alertSound.currentTime = 0;
            alertSound.play().catch(() => {});
          }
        } else if (ev.level === "warning") {
          showToast(`âš ï¸ ØªØ­Ø°ÙŠØ± Ù…Ù† ${ev.device_id}: ${ev.type}`, "warning");
        }

        updateMapForEvent(ev);
      });
    }

    // Resolve home event
    async function resolveHomeEvent(event) {
      try {
        // Calculate response time
        const responseTime = Math.floor((new Date() - new Date(event.timestamp)) / 1000);
        
        // Save resolution record
        await fetch('https://syntrue-absher.onrender.com/api/resolutions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event_id: event.id,
            device_id: event.device_id,
            device_name: event.device_id,
            original_type: event.type,
            original_level: event.level,
            resolved_by: 'ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø²Ù„',
            resolution_type: 'home',
            notes: `ØªÙ… Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: ${event.type}`,
            response_time_seconds: responseTime
          })
        });
        
        // Mark event as resolved in backend
        const response = await fetch(`${API_URL}/${event.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...event,
            status: 'resolved',
            resolved_at: new Date().toISOString()
          })
        });

        if (response.ok) {
          const minutes = Math.floor(responseTime / 60);
          const seconds = responseTime % 60;
          const timeStr = minutes > 0 ? `${minutes}Ø¯ ${seconds}Ø«` : `${seconds}Ø«`;
          showToast(`âœ… ØªÙ… Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©: ${event.device_id}\nÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©: ${timeStr}`, "info");
          // Refresh data
          setTimeout(() => fetchData(), 300);
        } else {
          showToast(`âŒ ÙØ´Ù„ Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©`, "danger");
        }
      } catch (error) {
        console.error('Error resolving event:', error);
        showToast(`âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„`, "danger");
      }
    }

    function updateOfficerCard(events) {
      const byOfficer = {};
      events.forEach((ev) => {
        if (!ev.device_id || !ev.device_id.startsWith("officer_")) return;
        const key = ev.device_id;
        const existing = byOfficer[key];
        if (!existing || parseEventTime(ev) > parseEventTime(existing)) {
          byOfficer[key] = ev;
        }
      });

      const officers = Object.values(byOfficer);
      const total = officers.length;
      if (total === 0) {
        officerSummaryText.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù† Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        officerSafeEl.textContent = "0";
        officerUnstableEl.textContent = "0";
        officerEmergencyEl.textContent = "0";
        return;
      }

      let safe = 0,
        unstable = 0,
        emergency = 0;

      officers.forEach((ev) => {
        const t = (ev.type || "").toLowerCase();
        if (t.endsWith("safe")) safe++;
        else if (t.endsWith("unstable")) unstable++;
        else if (t.endsWith("emergency")) emergency++;
        else {
          if (ev.level === "info") safe++;
          else if (ev.level === "warning") unstable++;
          else if (ev.level === "danger") emergency++;
        }
      });

      officerSafeEl.textContent = safe;
      officerUnstableEl.textContent = unstable;
      officerEmergencyEl.textContent = emergency;

      officerSummaryText.textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±ÙŠØ§Øª: ${total} â€¢ Ø¢Ù…Ù†: ${safe} â€¢ ØºÙŠØ± Ù…Ø³ØªÙ‚Ø±: ${unstable} â€¢ Ø·Ø§Ø±Ø¦: ${emergency}`;
    }

    /*************** ØªØµØ¯ÙŠØ± / Ø§Ø³ØªÙŠØ±Ø§Ø¯ ***************/
    function exportVisibleEventsToExcel() {
      if (!visibleEventsCache || visibleEventsCache.length === 0) {
        alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
        return;
      }
      const header = [
        "timestamp",
        "device_id",
        "type",
        "level",
        "status",
        "home_id",
        "absher_id",
      ];
      const rows = visibleEventsCache.map((e) => [
        e.timestamp,
        e.device_id,
        e.type,
        e.level,
        e.status || "open",
        e.home_id || DEFAULT_HOME_ID,
        e.absher_id || DEFAULT_ABSHER_ID,
      ]);
      const escape = (v) => `"${String(v).replace(/"/g, '""')}"`;
      let csv =
        header.join(";") +
        "\r\n" +
        rows.map((r) => r.map(escape).join(";")).join("\r\n");

      const blob = new Blob(["\uFEFF" + csv], {
        type: "text/csv;charset=utf-8;",
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const now = new Date();
      a.href = url;
      a.download = `events_${now
        .toISOString()
        .slice(0, 19)
        .replace(/[:T]/g, "-")}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function handleFileImport(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).filter((l) => l.trim().length > 0);
        if (lines.length <= 1) {
          alert("Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­.");
          return;
        }
        const header = lines[0].split(/[;,]/).map((h) => h.trim().toLowerCase());
        const hasHeader = header.includes("timestamp");
        let start = hasHeader ? 1 : 0;
        let imported = 0;

        for (let i = start; i < lines.length; i++) {
          const parts = lines[i].split(/[;,]/).map((p) => p.trim());
          if (parts.length < 4) continue;
          const ev = {
            timestamp: parts[0],
            device_id: parts[1],
            type: parts[2],
            level: parts[3],
            status: parts[4] || "open",
            home_id: parts[5] || DEFAULT_HOME_ID,
            absher_id: parts[6] || DEFAULT_ABSHER_ID,
          };
          try {
            await fetch(API_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(ev),
            });
            imported++;
          } catch (err) {
            console.error("Import error:", err);
          }
        }
        showToast(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${imported} Ø­Ø¯Ø« Ù…Ù† CSV âœ…`, "info");
        fetchEvents();
      };
      reader.readAsText(file, "utf-8");
    }

    /*************** Ù…Ø­Ø§ÙƒØ§Ø© ***************/
    function generateRandomEvent() {
      const devices = Object.keys(DEVICE_LOCATIONS).concat([
        "officer_1",
        "officer_2",
        "officer_3",
      ]);
      const types = [
        "door_open",
        "door_close",
        "motion_detected",
        "gas_detected",
        "officer_safe",
        "officer_unstable",
        "officer_emergency",
      ];
      const device = devices[Math.floor(Math.random() * devices.length)];
      const type = types[Math.floor(Math.random() * types.length)];

      let level = "info";
      if (type === "gas_detected") level = Math.random() < 0.8 ? "danger" : "warning";
      else if (type === "motion_detected")
        level = Math.random() < 0.6 ? "danger" : "warning";
      else if (type === "door_open") level = Math.random() < 0.4 ? "warning" : "info";
      else if (type.endsWith("emergency")) level = "danger";
      else if (type.endsWith("unstable")) level = "warning";

      return {
        device_id: device,
        type,
        level,
        timestamp: new Date().toISOString(),
        status: "open",
        home_id: DEFAULT_HOME_ID,
        absher_id: DEFAULT_ABSHER_ID,
      };
    }

    async function sendSimulatedEvent() {
      const ev = generateRandomEvent();
      try {
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(ev),
        });
      } catch (err) {
        console.error("Sim error:", err);
      }
    }

    /*************** Ø¨Ù„Ø§Øº ÙŠØ¯ÙˆÙŠ Ø¹Ù†Ø¯ ØºÙŠØ§Ø¨ ØµØ§Ø­Ø¨ Ø§Ù„Ù…Ù†Ø²Ù„ ***************/
    async function sendManualBurglaryReport() {
      const ok = confirm("ØªØ£ÙƒÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø³Ø±Ù‚Ø©ØŸ Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø± Ù…Ø±ÙƒØ² Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙˆØ±Ø§Ù‹.");
      if (!ok) return;
      manualBurglaryBtn.disabled = true;
      manualBurglaryBtn.textContent = "... Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº";
      try {
        const payload = {
          device_id: "manual_user_report",
          type: "burglary_report",
          level: "danger",
          status: "open",
          home_id: DEFAULT_HOME_ID,
          absher_id: DEFAULT_ABSHER_ID,
          timestamp: new Date().toISOString(),
          reporter: currentUser,
          message: "Ø¨Ù„Ø§Øº Ø³Ø±Ù‚Ø© - Ø§Ù„Ù…Ù†Ø²Ù„ Ø®Ø§Ù„ÙØŒ ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ù…Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ Ø¹Ù† Ø¨Ø¹Ø¯",
        };
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        showToast("ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª âœ…", "info");
        fetchEvents();
      } catch (err) {
        console.error("Manual report error:", err);
        showToast("ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„", "warning");
      } finally {
        manualBurglaryBtn.disabled = false;
        manualBurglaryBtn.textContent = "Ø¨Ù„Ø§Øº Ø³Ø±Ù‚Ø© (Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ø²Ù„)";
      }
    }

    /*************** Ø¨Ù„Ø§Øº Ø¹Ø§Ù… Ù„Ù„Ø´Ø±Ø·Ø© ***************/
    async function sendPoliceReport() {
      const reportText = prompt("Ø§ÙƒØªØ¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº:");
      if (!reportText || reportText.trim() === "") return;
      policeReportBtn.disabled = true;
      policeReportBtn.textContent = "... Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
      try {
        const payload = {
          device_id: "manual_police_report",
          type: "police_report",
          level: "danger",
          status: "open",
          home_id: DEFAULT_HOME_ID,
          absher_id: DEFAULT_ABSHER_ID,
          timestamp: new Date().toISOString(),
          reporter: currentUser,
          message: reportText.trim(),
        };
        await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ù„Ù„Ø´Ø±Ø·Ø© âœ…", "info");
        fetchEvents();
      } catch (err) {
        console.error("Police report error:", err);
        showToast("ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„", "warning");
      } finally {
        policeReportBtn.disabled = false;
        policeReportBtn.textContent = "Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ù„Ù„Ø´Ø±Ø·Ø©";
      }
    }

    function startSimulation() {
      if (simulationEnabled) return;
      simulationEnabled = true;
      simulationToggleBtn.textContent = "â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©";
      simulationInterval = setInterval(sendSimulatedEvent, 2200);
    }

    function stopSimulation() {
      simulationEnabled = false;
      simulationToggleBtn.textContent = "â–¶ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©";
      if (simulationInterval) {
        clearInterval(simulationInterval);
        simulationInterval = null;
      }
    }

    /*************** Fetch loop ***************/
    async function fetchEvents() {
      if (!fetchingEnabled) return;
      try {
        const res = await fetch(API_URL);
        const events = await res.json();

        offlineBanner.style.display = "none";
        connectionStatus.classList.remove("conn-offline");
        connectionStatus.classList.add("conn-online");
        connectionStatus.innerHTML = `<span class="conn-dot"></span> Ù…ØªØµÙ„`;

        // Filter out officer events - show ONLY home devices
        const homeEvents = events.filter(e => !e.device_id || !e.device_id.startsWith('officer_'));

        handleNewEvents(allEvents.length, homeEvents);
        const prevLen = allEvents.length;
        allEvents = homeEvents;

        let viewFiltered = allEvents.slice();
        const activeEvents = viewFiltered.filter(
          (e) => (e.status || "open") === "open"
        );

        const timeFiltered = filterByTime(viewFiltered);
        const levelFiltered = filterByLevel(timeFiltered);
        const deviceFiltered = filterByDevice(levelFiltered);
        const statusFiltered = filterByStatus(deviceFiltered);

        visibleEventsCache = statusFiltered;

        updateTopCards(activeEvents, statusFiltered, viewFiltered);
        updateTable(statusFiltered);
        updateRiskIndicator(activeEvents);
        updateDevicesSummary(viewFiltered);
      } catch (err) {
        console.error("Fetch error:", err);
        offlineBanner.style.display = "block";
        connectionStatus.classList.add("conn-offline");
        connectionStatus.classList.remove("conn-online");
        connectionStatus.innerHTML = `<span class="conn-dot"></span> ØºÙŠØ± Ù…ØªØµÙ„`;
      }
    }

    /*************** ØªÙ‚Ø§Ø±ÙŠØ± ***************/
    function openReportsPage() {
      const win = window.open("", "_blank");
      const events = allEvents.slice().reverse();
      const html = `
<html dir="rtl" lang="ar">
<head>
<meta charset="UTF-8" />
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</title>
<style>
body { font-family: system-ui, sans-serif; padding: 20px; }
h1 { margin-top: 0; }
table { width: 100%; border-collapse: collapse; font-size: 12px; }
th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: right; }
th { background: #f3f4f6; }
.meta { margin-bottom: 10px; color: #555; }
.btn-print { margin-bottom: 15px; padding: 6px 10px; }
</style>
</head>
<body>
<h1>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ø°ÙƒÙŠ</h1>
<p class="meta">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«: ${allEvents.length}</p>
<button class="btn-print" onclick="window.print()">ğŸ–¨ Ø·Ø¨Ø§Ø¹Ø© / Ø­ÙØ¸ PDF</button>
<table>
<thead>
<tr>
<th>Ø§Ù„ÙˆÙ‚Øª</th>
<th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
<th>Ø§Ù„Ù†ÙˆØ¹</th>
<th>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
<th>Ø§Ù„Ù…Ù†Ø²Ù„</th>
<th>Ø­Ø³Ø§Ø¨ Ø£Ø¨Ø´Ø±</th>
</tr>
</thead>
<tbody>
${events
  .map(
    (e) => `
<tr>
<td>${e.timestamp}</td>
<td>${e.device_id}</td>
<td>${e.type}</td>
<td>${e.level}</td>
<td>${e.status || "open"}</td>
<td>${e.home_id || DEFAULT_HOME_ID}</td>
<td>${e.absher_id || DEFAULT_ABSHER_ID}</td>
</tr>`
  )
  .join("")}
</tbody>
</table>
</body>
</html>`;
      win.document.write(html);
      win.document.close();
    }

    /*************** Ø§Ù„Ø«ÙŠÙ… ***************/
    function applyTheme(theme) {
      if (theme === "light") {
        document.body.classList.add("light-theme");
        themeToggleBtn.textContent = "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†";
      } else {
        document.body.classList.remove("light-theme");
        themeToggleBtn.textContent = "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­";
      }
      localStorage.setItem("dashboardTheme", theme);
    }

    /*************** Init ***************/
    document.addEventListener("DOMContentLoaded", () => {
      const savedTheme = localStorage.getItem("dashboardTheme") || "dark";
      applyTheme(savedTheme);

      initUnifiedMap();
      initLiveChart();
      fetchEvents();
      setInterval(fetchEvents, 3000);

      levelSelect.addEventListener("change", () => {
        currentLevelFilter = levelSelect.value;
        fetchEvents();
      });

      timeSelect.addEventListener("change", () => {
        currentTimeFilter = timeSelect.value;
        fetchEvents();
      });

      deviceSelect.addEventListener("change", () => {
        currentDeviceFilter = deviceSelect.value;
        fetchEvents();
      });

      statusSelect.addEventListener("change", () => {
        currentStatusFilter = statusSelect.value;
        fetchEvents();
      });

      simulationToggleBtn.addEventListener("click", () => {
        if (simulationEnabled) stopSimulation();
        else startSimulation();
      });

      manualBurglaryBtn.addEventListener("click", sendManualBurglaryReport);

      policeReportBtn.addEventListener("click", sendPoliceReport);

      resolveAllBtn.addEventListener("click", async () => {
        const ok = confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ¹Ù„ÙŠÙ… ÙƒÙ„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙƒÙ€ ØªÙ… Ø§Ù„Ø­Ù„ØŸ");
        if (!ok) return;
        try {
          const res = await fetch(`${API_URL}/resolve_all`, { method: "POST" });
          const data = await res.json();
          showToast(`ØªÙ… Ø­Ù„ ${data.resolved} Ø¨Ù„Ø§Øº âœ…`, "info");
          fetchEvents();
        } catch (err) {
          console.error(err);
          showToast("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª", "warning");
        }
      });

      themeToggleBtn.addEventListener("click", () => {
        const isLight = document.body.classList.contains("light-theme");
        applyTheme(isLight ? "dark" : "light");
      });
      
      // Logout functionality
      const logoutBtn = document.getElementById('logout-btn');
      const usernameDisplay = document.getElementById('usernameDisplay');
      
      // Display username
      usernameDisplay.textContent = currentUser;
      
      logoutBtn.addEventListener('click', logout);
      
      // Initial fetch for resolutions
      fetchResolutions();
      // Refresh resolutions every 5 seconds
      setInterval(fetchResolutions, 5000);
    });

    /*************** Logout Function ***************/
    function logout() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        localStorage.removeItem('homeAuth');
        localStorage.removeItem('homeUsername');
        window.location.href = '/static/welcome.html';
      }
    }
  </script>
</body>
</html>
